import { STARS, RASIS, YONI_ENEMIES, PLANET_FRIENDS, VASYA_DATA, NADI_GROUPS, NADI_NAMES, RASI_CHARACTERISTICS } from '../data/poruthamData.js';

// Calculates total malefic dosha points from Lagna, Moon, and Venus
const calculatePapasamyam = (chart, lagnamId, moonRasiId, venusHouseId) => {
    if (!chart) return { points: 0, details: [] };

    // Core Malefics
    const malefics = ['Su', 'Ma', 'Sa', 'Ra', 'Ke', 'роЪрпВ', 'роЪрпЖ', 'роЪ', 'ро░ро╛', 'роХрпЗ'];
    // Houses that cause dosham (2, 4, 7, 8, 12) + 1st house
    const doshamHouses = [1, 2, 4, 7, 8, 12];

    let totalPoints = 0;
    const details = [];

    const checkFromRef = (refHouseId, refName, weight) => {
        if (!refHouseId) return;
        doshamHouses.forEach(dh => {
            const targetHouse = (refHouseId + dh - 2) % 12 + 1;
            const planetsInHouse = chart[targetHouse] || [];

            planetsInHouse.forEach(p => {
                if (malefics.includes(p)) {
                    let point = weight;
                    // Mars in 7/8 is usually severe
                    if ((p === 'Ma' || p === 'роЪрпЖ') && (dh === 7 || dh === 8)) point *= 1.5;
                    // Saturn dosha is slightly milder
                    if (p === 'Sa' || p === 'роЪ') point *= 0.75;

                    totalPoints += point;
                    details.push(`${refName}роХрпНроХрпБ ${dh}-ро▓рпН ${p}`);
                }
            });
        });
    };

    // 1. From Lagna (Weight: 1.0)
    checkFromRef(lagnamId, "ро▓роХрпНройродрпНродро┐ро▒рпН", 1.0);
    // 2. From Moon (Weight: 0.75 - Mental/Emotional)
    checkFromRef(moonRasiId, "роЪроирпНродро┐ро░ройрпБроЩрпН", 0.75);
    // 3. From Venus (Weight: 0.5 - Marital Bliss)
    checkFromRef(venusHouseId, "роЪрпБроХрпНроХро┐ро░ройрпБроЩрпН", 0.5);

    return { points: parseFloat(totalPoints.toFixed(2)), details };
};

const getPlanetHouse = (chart, pIds) => {
    if (!chart) return null;
    for (const [houseId, planets] of Object.entries(chart)) {
        if (planets.some(p => pIds.includes(p))) return parseInt(houseId);
    }
    return null;
};

const analyzeNavamsam7th = (navChart, lagnamId) => {
    if (!navChart || !lagnamId) return { text: "", isGood: true };
    const seventhHouse = (lagnamId + 5) % 12 + 1;
    const planetsIn7th = navChart[seventhHouse] || [];

    const benefics = ['Ju', 'Ve', 'Me', 'роХрпБ', 'роЪрпБ', 'рокрпБ'];
    const malefics = ['Su', 'Ma', 'Sa', 'Ra', 'Ke', 'роЪрпВ', 'роЪрпЖ', 'роЪ', 'ро░ро╛', 'роХрпЗ'];

    const hasBenefic = planetsIn7th.some(p => benefics.includes(p));
    const hasMalefic = planetsIn7th.some(p => malefics.includes(p));

    if (hasBenefic && !hasMalefic) return { text: "роиро╡ро╛роорпНроЪродрпНродро┐ро▓рпН 7-роорпН ро╡рпАроЯрпНроЯро┐ро▓рпН роЪрпБрок роХро┐ро░роХроЩрпНроХро│рпН роЗро░рпБрокрпНрокродро╛ро▓рпН, родро┐ро░рпБроорог ро╡ро╛ро┤рпНроХрпНроХрпИ рооро┐роХро╡рпБроорпН роороХро┐ро┤рпНроЪрпНроЪро┐ропро╛роХ роЗро░рпБроХрпНроХрпБроорпН.", isGood: true };
    if (hasMalefic && !hasBenefic) return { text: "роиро╡ро╛роорпНроЪродрпНродро┐ро▓рпН 7-роорпН ро╡рпАроЯрпНроЯро┐ро▓рпН рокро╛рок роХро┐ро░роХроЩрпНроХро│рпН роЗро░рпБрокрпНрокродро╛ро▓рпН, ро╡ро╛ро┤рпНроХрпНроХрпИродрпН родрпБрогрпИропро┐роЯроорпН ро╡ро┐роЯрпНроЯрпБроХрпНроХрпКроЯрпБродрпНродрпБ роЪрпЖро▓рпНро╡родрпБ роЕро╡роЪро┐ропроорпН.", isGood: false };
    if (hasBenefic && hasMalefic) return { text: "роиро╡ро╛роорпНроЪродрпНродро┐ро▓рпН 7-роорпН ро╡рпАроЯрпНроЯро┐ро▓рпН роЪрпБрок рооро▒рпНро▒рпБроорпН рокро╛рок роХро┐ро░роХроЩрпНроХро│рпН роЗрогрпИроирпНродро┐ро░рпБрокрпНрокродро╛ро▓рпН, родро┐ро░рпБроорогрокрпН рокрпЖро░рпБро╡ро╛ро┤рпНро╡рпБ роХро▓ро╡рпИропро╛рой рокро▓ройрпНроХро│рпИродрпН родро░рпБроорпН.", isGood: true };

    return { text: "роиро╡ро╛роорпНроЪродрпНродро┐ро▓рпН 7-роорпН ро╡рпАроЯрпБ ро╡рпЖро▒рпНро▒ро┐роЯрооро╛роХ роЗро░рпБрокрпНрокродро╛ро▓рпН, рокрпКродрпБро╡ро╛рой родро┐ро░рпБроорог ро╡ро╛ро┤рпНроХрпНроХрпИ роЕроорпИропрпБроорпН.", isGood: true };
};

// Helper: Analyze 7th house (Kalathira Sthanam) from Rasi chart
const analyzeSeventhHouseRasi = (chart, lagnamId) => {
    if (!chart || !lagnamId) return null;
    const seventhHouse = (lagnamId + 5) % 12 + 1;
    const planetsIn7th = chart[seventhHouse] || [];
    const benefics = ['Ju', 'Ve', 'Me', 'роХрпБ', 'роЪрпБ', 'рокрпБ'];
    const malefics = ['Su', 'Ma', 'Sa', 'Ra', 'Ke', 'роЪрпВ', 'роЪрпЖ', 'роЪ', 'ро░ро╛', 'роХрпЗ'];
    return {
        house: seventhHouse,
        planets: planetsIn7th,
        hasBenefic: planetsIn7th.some(p => benefics.includes(p)),
        hasMalefic: planetsIn7th.some(p => malefics.includes(p)),
        hasJupiter: planetsIn7th.some(p => ['Ju', 'роХрпБ'].includes(p)),
        hasVenus: planetsIn7th.some(p => ['Ve', 'роЪрпБ'].includes(p)),
        hasMars: planetsIn7th.some(p => ['Ma', 'роЪрпЖ'].includes(p)),
        hasSaturn: planetsIn7th.some(p => ['Sa', 'роЪ'].includes(p)),
        hasRahu: planetsIn7th.some(p => ['Ra', 'ро░ро╛'].includes(p)),
        isEmpty: planetsIn7th.length === 0
    };
};

// Helper: Check Sevvai Dosham (Mars Dosha / Manglik)
const checkSevvaiDosham = (chart, lagnamId) => {
    if (!chart || !lagnamId) return { hasDosham: false, severity: 'none', houses: [] };
    const marsIds = ['Ma', 'роЪрпЖ'];
    const doshamHouses = [1, 2, 4, 7, 8, 12]; // Houses where Mars causes dosham
    const affectedHouses = [];
    doshamHouses.forEach(dh => {
        const targetHouse = (lagnamId + dh - 2) % 12 + 1;
        const planets = chart[targetHouse] || [];
        if (planets.some(p => marsIds.includes(p))) {
            affectedHouses.push(dh);
        }
    });
    const severity = affectedHouses.length === 0 ? 'none' :
        (affectedHouses.includes(7) || affectedHouses.includes(8)) ? 'severe' : 'mild';
    return { hasDosham: affectedHouses.length > 0, severity, houses: affectedHouses };
};

// Generate comprehensive remedies
const generatePariharam = (results, hasCharts, bSevvai, gSevvai, doshamResult, bNavamsa, gNavamsa) => {
    const remedies = [];
    if (results.rajju.status === "No Match") {
        remedies.push("ЁЯФ▒ родро┐ро░рпБроЪрпНроЪрпЖроирпНродрпВро░рпН роорпБро░рпБроХройрпН роХрпЛропро┐ро▓ро┐ро▓рпН ро░роЬрпНроЬрпБ родрпЛро╖ роиро┐ро╡ро░рпНродрпНродро┐ рокрпВроЬрпИ роЪрпЖропрпНропро╡рпБроорпН.");
        remedies.push("ЁЯкФ роТро╡рпНро╡рпКро░рпБ роЪрпЖро╡рпНро╡ро╛ропрпНроХрпНроХро┐ро┤роорпИропрпБроорпН роЖроЮрпНроЪроирпЗропро░рпН роХрпЛропро┐ро▓ро┐ро▓рпН ро╡ро┐ро▓рпНро╡ роЕро░рпНроЪрпНроЪройрпИ роЪрпЖропрпНропро╡рпБроорпН.");
    }
    if (results.nadi?.status === "No Match") {
        remedies.push("ЁЯРД роиро╛роЯро┐ родрпЛро╖ роиро┐ро╡ро░рпНродрпНродро┐роХрпНроХро╛роХ родроЩрпНроХроиро╛роЯро┐ роОройрпНройрпБроорпН родро╛ройроорпН (родроЩрпНроХ роиро╛роХроорпН родро╛ройроорпН) роЪрпЖропрпНропро╡рпБроорпН.");
        remedies.push("ЁЯЩП ро░ро╛роорпЗро╕рпНро╡ро░роорпН роХрпЛропро┐ро▓ро┐ро▓рпН роиро╛роЯро┐ родрпЛро╖ рокро░ро┐роХро╛ро░роорпН роЪрпЖропрпНропро╡рпБроорпН.");
    }
    if (hasCharts && bSevvai?.hasDosham && !gSevvai?.hasDosham) {
        remedies.push("ЁЯФ┤ рокрпЖрогрпНрогрпБроХрпНроХрпБ роЪрпЖро╡рпНро╡ро╛ропрпН родрпЛро╖роорпН роЙро│рпНро│родрпБ тАФ родро┐ро░рпБроиро│рпНро│ро╛ро▒рпБ роЪройрпАро╕рпНро╡ро░ро░рпН роХрпЛропро┐ро▓рпН рооро▒рпНро▒рпБроорпН ро╡рпИродрпНродрпАро╕рпНро╡ро░ройрпН роХрпЛропро┐ро▓рпН ро╡ро┤ро┐рокро╛роЯрпБ роЕро╡роЪро┐ропроорпН.");
        remedies.push("ЁЯТО рокрпЖрогрпН рокро╡ро│роорпН (Red Coral) роорпЛродро┐ро░роорпН роЕрогро┐ро╡родрпБ роиройрпНроорпИ родро░рпБроорпН.");
    }
    if (hasCharts && gSevvai?.hasDosham && !bSevvai?.hasDosham) {
        remedies.push("ЁЯФ┤ роЖрогрпБроХрпНроХрпБ роЪрпЖро╡рпНро╡ро╛ропрпН родрпЛро╖роорпН роЙро│рпНро│родрпБ тАФ ро╡рпИродрпНродрпАро╕рпНро╡ро░ройрпН роХрпЛропро┐ро▓ро┐ро▓рпН роЪрпЖро╡рпНро╡ро╛ропрпН родрпЛро╖ рокро░ро┐роХро╛ро░роорпН роЪрпЖропрпНропро▓ро╛роорпН.");
        remedies.push("ЁЯТО роЖрогрпН рокро╡ро│роорпН (Red Coral) роорпЛродро┐ро░роорпН роЕрогро┐ро╡родрпБ роиро▓рпНро▓родрпБ.");
    }
    if (hasCharts && doshamResult?.match === "No Match") {
        remedies.push("тЪЦя╕П рокро╛рокроЪро╛роорпНроп ро╡рпЗро▒рпБрокро╛роЯрпНроЯро┐ро▒рпНроХрпБ тАФ роХрпБро▓родрпЖропрпНро╡ ро╡ро┤ро┐рокро╛роЯрпБ рооро▒рпНро▒рпБроорпН роиро╡роХрпНроХро┐ро░роХ ро╣рпЛроороорпН роЪрпЖропрпНропро╡рпБроорпН.");
    }
    if (results.vedhai?.status === "No Match") {
        remedies.push("ЁЯЫбя╕П ро╡рпЗродрпИ родрпЛро╖ роиро┐ро╡ро░рпНродрпНродро┐роХрпНроХро╛роХ тАФ родро┐ро░рпБроорогродрпНродро┐ро▒рпНроХрпБ роорпБройрпН роЪрпБродро░рпНроЪрой ро╣рпЛроороорпН роЪрпЖропрпНропро▓ро╛роорпН.");
    }
    if (results.gana?.status === "No Match") {
        remedies.push("ЁЯЩП роХрогрокрпН рокрпКро░рпБродрпНродрооро┐ройрпНроорпИроХрпНроХрпБ тАФ роХро╛роЮрпНроЪро┐рокрпБро░роорпН роХро╛рооро╛роЯрпНроЪро┐ роЕроорпНрооройрпН роХрпЛропро┐ро▓ро┐ро▓рпН роЪро┐ро▒рокрпНрокрпБ роЕро░рпНроЪрпНроЪройрпИ роЪрпЖропрпНропро╡рпБроорпН.");
    }
    if (hasCharts && bNavamsa && !bNavamsa.isGood) {
        remedies.push("ЁЯк╖ рокрпЖрогрпНрогро┐ройрпН роиро╡ро╛роорпНроЪ 7-роорпН ро╡рпАроЯрпНроЯро┐ро▓рпН рокро╛родро┐рокрпНрокрпБ тАФ роТро╡рпНро╡рпКро░рпБ ро╡рпЖро│рпНро│ро┐роХрпНроХро┐ро┤роорпИропрпБроорпН ро▓роЯрпНроЪрпБрооро┐ рокрпВроЬрпИ роЪрпЖропрпНропро╡рпБроорпН.");
    }
    if (hasCharts && gNavamsa && !gNavamsa.isGood) {
        remedies.push("ЁЯк╖ роЖрогро┐ройрпН роиро╡ро╛роорпНроЪ 7-роорпН ро╡рпАроЯрпНроЯро┐ро▓рпН рокро╛родро┐рокрпНрокрпБ тАФ роТро╡рпНро╡рпКро░рпБ ро╡ро┐ропро╛ро┤роХрпНроХро┐ро┤роорпИропрпБроорпН роХрпБро░рпБ рокроХро╡ро╛ройрпН ро╡ро┤ро┐рокро╛роЯрпБ роЪрпЖропрпНропро╡рпБроорпН.");
    }
    if (remedies.length === 0) {
        remedies.push("тЬЕ роХрпБро▒ро┐рокрпНрокро┐роЯродрпНродроХрпНроХ родрпЛро╖роЩрпНроХро│рпН роЗро▓рпНро▓ро╛родродро╛ро▓рпН роЪро┐ро▒рокрпНрокрпБ рокро░ро┐роХро╛ро░роЩрпНроХро│рпН родрпЗро╡рпИропро┐ро▓рпНро▓рпИ. роХрпБро▓родрпЖропрпНро╡ ро╡ро┤ро┐рокро╛роЯрпБ роороЯрпНроЯрпБроорпЗ рокрпЛродрпБрооро╛ройродрпБ.");
    }
    return remedies;
};

const generateLifeSummary = (bride, groom, bridePapasamyam, groomPapasamyam, bNavamsa, gNavamsa, hasCharts, results) => {
    const sections = [];
    const bRasi = RASIS.find(r => r.id === parseInt(bride.rasiId));
    const gRasi = RASIS.find(r => r.id === parseInt(groom.rasiId));
    const bStar = STARS.find(s => s.id === parseInt(bride.starId));
    const gStar = STARS.find(s => s.id === parseInt(groom.starId));
    const bChar = RASI_CHARACTERISTICS[parseInt(bride.rasiId)] || {};
    const gChar = RASI_CHARACTERISTICS[parseInt(groom.rasiId)] || {};

    // Count matches
    const totalMatched = Object.values(results).filter(r => r.status === "Match").length;
    const importantFields = ['rasi', 'rasiAthipathi', 'rajju', 'mahendra', 'yoni'];
    const importantMatches = importantFields.filter(f => results[f]?.status === "Match").length;

    // Chart-based analysis
    const bLagna = getPlanetHouse(bride.rasiChart, ['La', 'ро▓роХрпН']) || parseInt(bride.rasiId);
    const gLagna = getPlanetHouse(groom.rasiChart, ['La', 'ро▓роХрпН']) || parseInt(groom.rasiId);
    const b7thHouse = hasCharts ? analyzeSeventhHouseRasi(bride.rasiChart, bLagna) : null;
    const g7thHouse = hasCharts ? analyzeSeventhHouseRasi(groom.rasiChart, gLagna) : null;
    const bSevvai = hasCharts ? checkSevvaiDosham(bride.rasiChart, bLagna) : null;
    const gSevvai = hasCharts ? checkSevvaiDosham(groom.rasiChart, gLagna) : null;

    // ===================== SECTION 1: VERDICT =====================
    sections.push("## ЁЯХЙя╕П родро┐ро░рпБроорогрокрпН рокрпКро░рпБродрпНрод роорпБроЯро┐ро╡рпБ (Marriage Verdict)");
    if (results.rajju.status === "No Match") {
        sections.push(`тЫФ **роЗроирпНродродрпН родро┐ро░рпБроорогроорпН роЪрпЖропрпНро╡родрпБ роЙроХроирпНродродро▓рпНро▓.** ро░роЬрпНроЬрпБрокрпН рокрпКро░рпБродрпНродроорпН роЗро▓рпНро▓ро╛родродро╛ро▓рпН рооро╛роЩрпНроХро▓рпНроп рокро▓роорпН рооро▒рпНро▒рпБроорпН роЖропрпБро│рпН рокро▓роорпН роХрпБро▒рпИро╡ро╛роХ роЙро│рпНро│родрпБ. родрооро┐ро┤рпНроиро╛роЯрпБ роЬрпЛродро┐роЯрокрпН рокро╛ро░роорпНрокро░ро┐ропрокрпНрокроЯро┐, ро░роЬрпНроЬрпБрокрпН рокрпКро░рпБродрпНродрооро┐ройрпНро▒ро┐ родро┐ро░рпБроорогроорпН роЪрпЖропрпНро╡родрпБ роХрпВроЯро╛родрпБ роОройрпНрокродрпЗ роиро┐ро▓рпИропро╛рой роХрпКро│рпНроХрпИ. 12 рокрпКро░рпБродрпНродроЩрпНроХро│ро┐ро▓рпН ${totalMatched} роороЯрпНроЯрпБроорпЗ рокрпКро░рпБроирпНродрпБроХро┐ро▒родрпБ.`);
    } else if (importantMatches >= 4 && totalMatched >= 8) {
        sections.push(`тЬЕ **роЗроирпНродродрпН родро┐ро░рпБроорогроорпН рооро┐роХроЪрпН роЪро┐ро▒рокрпНрокро╛рой рокрпКро░рпБродрпНродроорпН!** роорпБроХрпНроХро┐ропрооро╛рой 5 рокрпКро░рпБродрпНродроЩрпНроХро│ро┐ро▓рпН ${importantMatches} рокрпКро░рпБродрпНродроЩрпНроХро│рпБроорпН, роорпКродрпНродроорпН 12-ро▓рпН ${totalMatched} рокрпКро░рпБродрпНродроЩрпНроХро│рпБроорпН роЪро┐ро▒рокрпНрокро╛роХ роЕроорпИроирпНродрпБро│рпНро│рой. родрооро┐ро┤рпНроиро╛роЯрпБ роЬрпЛродро┐роЯ рооро░рокрпБрокрпНрокроЯро┐ роЗродрпБ роЙродрпНродроорооро╛рой родро┐ро░рпБроорогрокрпН рокрпКро░рпБродрпНродроорпН.`);
    } else if (importantMatches >= 3) {
        sections.push(`ЁЯЯб **роЗроирпНродродрпН родро┐ро░рпБроорогроорпН роироЯроХрпНроХро▓ро╛роорпН, роЖройро╛ро▓рпН роЪро┐ро▓ роХрпБро▒рпИрокро╛роЯрпБроХро│рпН роЙро│рпНро│рой.** роорпБроХрпНроХро┐ропрооро╛рой 5-ро▓рпН ${importantMatches} рокрпКро░рпБродрпНродроЩрпНроХро│рпН роЙро│рпНро│рой. рокро░ро┐роХро╛ро░роЩрпНроХро│рпН роЪрпЖропрпНродро╛ро▓рпН роиро▓рпНро▓ ро╡ро╛ро┤рпНроХрпНроХрпИ роЕроорпИропрпБроорпН.`);
    } else {
        sections.push(`тЪая╕П **роЗроирпНродродрпН родро┐ро░рпБроорогроорпН рокрпКро░рпБродрпНродроорпН роХрпБро▒рпИро╡ро╛роХ роЙро│рпНро│родрпБ.** роорпБроХрпНроХро┐ропрооро╛рой 5-ро▓рпН ${importantMatches} роороЯрпНроЯрпБроорпЗ рокрпКро░рпБроирпНродрпБроХро┐ро▒родрпБ. роорпКродрпНродроорпН ${totalMatched}/12. роХрпВроЯрпБродро▓рпН роЬрпЛродро┐роЯ роЖро▓рпЛроЪройрпИ роЕро╡роЪро┐ропроорпН.`);
    }

    // ===================== SECTION 2: PERSONALITY =====================
    if (bRasi && gRasi) {
        sections.push("## ЁЯзм родроорпНрокродро┐ропро░рпН роЖро│рпБроорпИ рокроХрпБрокрпНрокро╛ропрпНро╡рпБ (Personality Analysis)");
        sections.push(`**рокрпЖрогрпН (${bRasi.nameTamil} ро░ро╛роЪро┐):** ${bChar.trait || ''} роЙроЯрпИроп роЗро╡ро░рпН, ${bChar.positives || ''} роЖроХро┐роп роиро▒рпНроХрпБрогроЩрпНроХро│рпИроХрпН роХрпКрогрпНроЯро╡ро░рпН. роЖройро╛ро▓рпН ${bChar.challenges || ''} рокрпЛройрпНро▒ роЪро╡ро╛ро▓рпНроХро│рпИропрпБроорпН роОродро┐ро░рпНроХрпКро│рпНро│ро▓ро╛роорпН.`);
        sections.push(`**роЖрогрпН (${gRasi.nameTamil} ро░ро╛роЪро┐):** ${gChar.trait || ''} роХрпКрогрпНроЯ роЗро╡ро░рпН, ${gChar.positives || ''} роЖроХро┐роп роЪро┐ро▒рокрпНрокрпБроХро│рпН роЙро│рпНро│ро╡ро░рпН. ${gChar.challenges || ''} рокрпЛройрпНро▒ро╡рпИ роЪро╡ро╛ро▓рпНроХро│ро╛роХ роЗро░рпБроХрпНроХро▓ро╛роорпН.`);

        // Nature compatibility
        if (bChar.nature === gChar.nature) {
            sections.push(`ЁЯФе роЗро░рпБро╡ро░рпБроорпН роТро░рпЗ роЗропро▓рпНрокрпБ (${bChar.nature === 'fire' ? 'роирпЖро░рпБрокрпНрокрпБ' : bChar.nature === 'earth' ? 'рокрпВрооро┐' : bChar.nature === 'water' ? 'роирпАро░рпН' : 'роХро╛ро▒рпНро▒рпБ'}) роХрпКрогрпНроЯро╡ро░рпНроХро│рпН. роТро▒рпНро▒рпБроорпИропрпБроорпН, роЪро┐ро▓ роирпЗро░роЩрпНроХро│ро┐ро▓рпН роорпЛродро▓рпБроорпН роЗро░рпБроХрпНроХрпБроорпН.`);
        } else if ((bChar.nature === 'fire' && gChar.nature === 'air') || (bChar.nature === 'air' && gChar.nature === 'fire') || (bChar.nature === 'earth' && gChar.nature === 'water') || (bChar.nature === 'water' && gChar.nature === 'earth')) {
            sections.push("ЁЯдЭ роЗро░рпБро╡ро░ро┐ройрпН роЗропро▓рпНрокрпБроорпН роТройрпНро▒рпИропрпКройрпНро▒рпБ роиро┐ро▒рпИро╡рпБ роЪрпЖропрпНропрпБроорпН ро╡роХрпИропро┐ро▓рпН роЕроорпИроирпНродрпБро│рпНро│родрпБ тАФ роЗродрпБ рооро┐роХроЪрпН роЪро┐ро▒роирпНрод роХрпВроЯрпНроЯрогро┐.");
        } else {
            sections.push("тЪб роЗро░рпБро╡ро░ро┐ройрпН роЗропро▓рпНрокрпБроорпН ро╡рпЗро▒рпБрокроЯрпНроЯродро╛ро▓рпН, роТро░рпБро╡ро░рпН рооро▒рпНро▒ро╡ро░рпИрокрпН рокрпБро░ро┐роирпНродрпБроХрпКро│рпНро│ роорпБропро▒рпНроЪро┐ родрпЗро╡рпИ.");
        }
    }

    // ===================== SECTION 3: PORUTHAM IMPACT =====================
    sections.push("## ЁЯУЛ рокрпКро░рпБродрпНродроорпН ро╡ро╛ро░ро┐ропро╛рой ро╡ро╛ро┤рпНроХрпНроХрпИ родро╛роХрпНроХроорпН (Porutham Impact on Life)");

    // Dina
    if (results.dina?.status === "Match") {
        sections.push("**1. родро┐ройрокрпН рокрпКро░рпБродрпНродроорпН тЬЕ:** родро┐ройроЪро░ро┐ ро╡ро╛ро┤рпНроХрпНроХрпИропро┐ро▓рпН роЗро░рпБро╡ро░рпБроХрпНроХрпБроорпН роЗроЯрпИропрпЗ роиро▓рпНро▓ роТродрпНродро┐роЪрпИро╡рпБ роЗро░рпБроХрпНроХрпБроорпН. роХро╛ро▓рпИ роорпБродро▓рпН роЗро░ро╡рпБ ро╡ро░рпИ роТро░рпБро╡ро░рпИ роТро░рпБро╡ро░рпН рокрпБро░ро┐роирпНродрпБроХрпКрогрпНроЯрпБ, роТро░рпЗ роЕро▓рпИропро┐ро▓рпН роЗропроЩрпНроХрпБро╡ро╛ро░рпНроХро│рпН.");
    } else {
        sections.push("**1. родро┐ройрокрпН рокрпКро░рпБродрпНродроорпН тЭМ:** родро┐ройроЪро░ро┐ ро╡ро╛ро┤рпНроХрпНроХрпИропро┐ро▓рпН роЪро┐ро▒ро┐роп роХро░рпБродрпНродрпБ ро╡рпЗро▒рпБрокро╛роЯрпБроХро│рпН роПро▒рпНрокроЯро▓ро╛роорпН. роХро╛ро▓рпИ рокро┤роХрпНроХро╡ро┤роХрпНроХроЩрпНроХро│рпН, роЙрогро╡рпБ ро╡ро┐ро░рпБрокрпНрокроЩрпНроХро│рпН рокрпЛройрпНро▒ро╡ро▒рпНро▒ро┐ро▓рпН роЪрооро░роЪроорпН роЪрпЖропрпНродрпБроХрпКро│рпНро│ ро╡рпЗрогрпНроЯрпБроорпН.");
    }

    // Gana
    if (results.gana?.status === "Match") {
        sections.push("**2. роХрогрокрпН рокрпКро░рпБродрпНродроорпН тЬЕ:** роЗро░рпБро╡ро░ро┐ройрпН роХрпБрогроорпБроорпН роТродрпНродрпБро╡ро░рпБроорпН. роХрпЛрокроорпН, роЪроирпНродрпЛро╖роорпН, родрпБроХрпНроХроорпН рокрпЛройрпНро▒ роЙрогро░рпНроЪрпНроЪро┐роХро│ро┐ро▓рпН роТро░рпБро╡ро░рпИ роТро░рпБро╡ро░рпН рокрпБро░ро┐роирпНродрпБроХрпКро│рпНро╡ро╛ро░рпНроХро│рпН. роХрпБроЯрпБроорпНрокродрпНродро┐ро▓рпН роЕроорпИродро┐ропро╛рой роЪрпВро┤ро▓рпН роиро┐ро▓ро╡рпБроорпН.");
    } else {
        sections.push("**2. роХрогрокрпН рокрпКро░рпБродрпНродроорпН тЭМ:** роЗро░рпБро╡ро░ро┐ройрпН роХрпБрогро╛родро┐роЪропроЩрпНроХро│рпН ро╡рпЗро▒рпБрокроЯрпНроЯро╡рпИ. роТро░рпБро╡ро░рпН роЕроорпИродро┐ропро╛ройро╡ро░ро╛роХ роЗро░рпБроХрпНроХрпБроорпН рокрпЛродрпБ рооро▒рпНро▒ро╡ро░рпН роЖро╡рпЗроЪрооро╛роХ роЗро░рпБроХрпНроХро▓ро╛роорпН. рокрпКро▒рпБроорпИропрпБроорпН рокрпБро░ро┐родро▓рпБроорпН роЕро╡роЪро┐ропроорпН.");
    }

    // Mahendra
    if (results.mahendra?.status === "Match") {
        sections.push("**3. роороХрпЗроирпНродро┐ро░рокрпН рокрпКро░рпБродрпНродроорпН тЬЕ:** рокрпБродрпНродро┐ро░ рокро╛роХрпНроХро┐ропроорпН роЪро┐ро▒рокрпНрокро╛роХ роЕроорпИропрпБроорпН. роЖро░рпЛроХрпНроХро┐ропрооро╛рой роХрпБро┤роирпНродрпИроХро│рпН рокро┐ро▒роХрпНроХрпБроорпН. роХрпБроЯрпБроорпНрокродрпНродро┐ро▓рпН роЪрпЖро▓рпНро╡роорпБроорпН ро╡ро│роорпБроорпН рокрпЖро░рпБроХрпБроорпН.");
    } else {
        sections.push("**3. роороХрпЗроирпНродро┐ро░рокрпН рокрпКро░рпБродрпНродроорпН тЭМ:** рокрпБродрпНродро┐ро░ рокро╛роХрпНроХро┐ропродрпНродро┐ро▓рпН родро╛роородроорпН роПро▒рпНрокроЯро▓ро╛роорпН. роЪроирпНродро╛рой роХрпЛрокро╛ро▓ рокрпВроЬрпИ рооро▒рпНро▒рпБроорпН роХрпБро▓родрпЖропрпНро╡ ро╡ро┤ро┐рокро╛роЯрпБ рокро░ро┐роирпНродрпБро░рпИроХрпНроХрокрпНрокроЯрпБроХро┐ро▒родрпБ.");
    }

    // Sthree Dheerkha
    if (results.sthree?.status === "Match") {
        sections.push("**4. ро╕рпНродро┐ро░рпА родрпАро░рпНроХрпНроХроорпН тЬЕ:** рооройрпИро╡ро┐ропро┐ройрпН рооро╛роЩрпНроХро▓рпНроп рокро▓роорпН роЪро┐ро▒рокрпНрокро╛роХ роЙро│рпНро│родрпБ. роирпАрогрпНроЯ роЪрпБроороЩрпНроХро▓ро┐родрпНродройрпНроорпИропрпБроорпН роХрпБроЯрпБроорпНрок роиро▓роорпБроорпН роЙро▒рпБродро┐.");
    } else {
        sections.push("**4. ро╕рпНродро┐ро░рпА родрпАро░рпНроХрпНроХроорпН тЭМ:** рооро╛роЩрпНроХро▓рпНроп рокро▓роорпН роХрпБро▒рпИро╡ро╛роХ роЗро░рпБрокрпНрокродро╛ро▓рпН, роТро╡рпНро╡рпКро░рпБ роЪрпЖро╡рпНро╡ро╛ропрпН рооро▒рпНро▒рпБроорпН ро╡рпЖро│рпНро│ро┐роХрпНроХро┐ро┤роорпИропрпБроорпН роороЮрпНроЪро│рпН роХро╛рокрпНрокрпБ роХроЯрпНроЯро┐ ро╡ро┤ро┐рокро╛роЯрпБ роЪрпЖропрпНропро╡рпБроорпН.");
    }

    // Yoni
    if (results.yoni?.status === "Match") {
        sections.push("**5. ропрпЛройро┐рокрпН рокрпКро░рпБродрпНродроорпН тЬЕ:** родро╛роорпНрокродрпНродро┐роп ро╡ро╛ро┤рпНроХрпНроХрпИ рооро┐роХроЪрпН роЪро┐ро▒рокрпНрокро╛роХ роЕроорпИропрпБроорпН. роЗро░рпБро╡ро░рпБроХрпНроХрпБроорпН роЗроЯрпИропрпЗ роИро░рпНрокрпНрокрпБроорпН, роЕроирпНроиро┐ропрпЛройрпНропроорпБроорпН роХрпБро▒рпИропро╛родрпБ. роЙроЯро▓рпН рооро▒рпНро▒рпБроорпН рооройроЖро░рпЛроХрпНроХро┐ропроорпН роЪро┐ро▒рокрпНрокро╛роХ роЗро░рпБроХрпНроХрпБроорпН.");
    } else {
        sections.push("**5. ропрпЛройро┐рокрпН рокрпКро░рпБродрпНродроорпН тЭМ:** родро╛роорпНрокродрпНродро┐роп ро╡ро╛ро┤рпНро╡ро┐ро▓рпН роЪро┐ро▓ роЪро┐роХрпНроХро▓рпНроХро│рпН роПро▒рпНрокроЯро▓ро╛роорпН. роТро░рпБро╡ро░рпН рооро▒рпНро▒ро╡ро░ро┐ройрпН родрпЗро╡рпИроХро│рпИрокрпН рокрпБро░ро┐роирпНродрпБроХрпКрогрпНроЯрпБ роЪрпЖропрпНроп ро╡рпЗрогрпНроЯрпБроорпН. роХрпЛропро┐ро▓рпН ро╡ро┤ро┐рокро╛роЯрпБ роиройрпНроорпИ родро░рпБроорпН.");
    }

    // Rasi
    if (results.rasi?.status === "Match") {
        sections.push("**6. ро░ро╛роЪро┐рокрпН рокрпКро░рпБродрпНродроорпН тЬЕ:** роХрпБроЯрпБроорпНрок ро╡ро╛ро┤рпНроХрпНроХрпИропро┐ро▓рпН роТро▒рпНро▒рпБроорпИ, рооройрокрпНрокрпКро░рпБродрпНродроорпН, роЪрпЖро▓рпНро╡ ро╡ро│роорпН роЪро┐ро▒рокрпНрокро╛роХ роЗро░рпБроХрпНроХрпБроорпН. ро╡роорпНроЪ ро╡ро┐ро░рпБродрпНродро┐ роиройрпНро▒ро╛роХ роироЯроХрпНроХрпБроорпН.");
    } else {
        sections.push("**6. ро░ро╛роЪро┐рокрпН рокрпКро░рпБродрпНродроорпН тЭМ:** рооройрокрпНрокрпКро░рпБродрпНродродрпНродро┐ро▓рпН роЪро┐ро▒рпБ роХрпБро▒рпИрокро╛роЯрпБроХро│рпН роХро╛рогрокрпНрокроЯро▓ро╛роорпН. роЪро┐ро▓роирпЗро░роЩрпНроХро│ро┐ро▓рпН роОродро┐ро░рпНрооро▒рпИ роОрогрпНрогроЩрпНроХро│рпН ро╡ро░ро▓ро╛роорпН. роЗро░рпБро╡ро░рпБроорпН ро╡ро┐роЯрпНроЯрпБроХрпНроХрпКроЯрпБроХрпНроХ ро╡рпЗрогрпНроЯрпБроорпН.");
    }

    // Rasi Athipathi
    if (results.rasiAthipathi?.status === "Match") {
        sections.push("**7. ро░ро╛роЪро┐ роЕродро┐рокродро┐рокрпН рокрпКро░рпБродрпНродроорпН тЬЕ:** роЗро░рпБро╡ро░ро┐ройрпН ро░ро╛роЪро┐ роЕродро┐рокродро┐ роХро┐ро░роХроЩрпНроХро│рпН роироЯрпНрокрпБ роЙро▒ро╡ро┐ро▓рпН роЙро│рпНро│рой. роХрпБроЯрпБроорпНрокродрпНродро┐ро▓рпН роЪрогрпНроЯрпИ роХрпБро▒рпИро╡ро╛роХро╡рпБроорпН, роЕройрпНропрпЛройрпНропроорпН роЕродро┐роХрооро╛роХро╡рпБроорпН роЗро░рпБроХрпНроХрпБроорпН.");
    } else {
        sections.push("**7. ро░ро╛роЪро┐ роЕродро┐рокродро┐рокрпН рокрпКро░рпБродрпНродроорпН тЭМ:** ро░ро╛роЪро┐ роЕродро┐рокродро┐ роХро┐ро░роХроЩрпНроХро│рпН рокроХрпИ роЙро▒ро╡ро┐ро▓рпН роЙро│рпНро│рой. роХро░рпБродрпНродрпБ ро╡рпЗро▒рпБрокро╛роЯрпБроХро│рпН, роЪро┐ро▒рпБ роЪрогрпНроЯрпИроХро│рпН ро╡ро░ ро╡ро╛ропрпНрокрпНрокрпБ роЙрогрпНроЯрпБ.");
    }

    // Vasya
    if (results.vasya?.status === "Match") {
        sections.push("**8. ро╡роЪро┐ропрокрпН рокрпКро░рпБродрпНродроорпН тЬЕ:** роТро░рпБро╡ро░рпН роорпАродрпБ роТро░рпБро╡ро░рпБроХрпНроХрпБ роЗропро▓рпНрокро╛рой роИро░рпНрокрпНрокрпБроорпН роЪрпЖро▓рпНро╡ро╛роХрпНроХрпБроорпН роЙрогрпНроЯрпБ. роХрогро╡ройрпН-рооройрпИро╡ро┐ роЗроЯрпИропрпЗ роЕройрпНрокрпБ рооро▒рпНро▒рпБроорпН рооро░ро┐ропро╛родрпИ роиро┐ро▓рпИродрпНродро┐ро░рпБроХрпНроХрпБроорпН.");
    } else {
        sections.push("**8. ро╡роЪро┐ропрокрпН рокрпКро░рпБродрпНродроорпН тЭМ:** роТро░рпБро╡ро░рпН роорпАродрпБ роТро░рпБро╡ро░рпБроХрпНроХрпБ роЗропро▓рпНрокро╛рой роИро░рпНрокрпНрокрпБ роХрпБро▒рпИро╡ро╛роХ роЗро░рпБроХрпНроХро▓ро╛роорпН. роЙро▒ро╡рпИ ро╡ро▓рпБрокрпНрокроЯрпБродрпНрод роХрпВроЯрпБродро▓рпН роорпБропро▒рпНроЪро┐ родрпЗро╡рпИ.");
    }

    // Rajju
    if (results.rajju?.status === "Match") {
        sections.push("**9. ро░роЬрпНроЬрпБрокрпН рокрпКро░рпБродрпНродроорпН тЬЕ:** рооро┐роХ роорпБроХрпНроХро┐ропрооро╛рой рокрпКро░рпБродрпНродроорпН роЪро┐ро▒рокрпНрокро╛роХ роЙро│рпНро│родрпБ! роХрогро╡ройрпН-рооройрпИро╡ро┐ роЗро░рпБро╡ро░рпБроорпН роирпАрогрпНроЯ роЖропрпБро│рпБроЯройрпН роороХро┐ро┤рпНроЪрпНроЪро┐ропро╛рой ро╡ро╛ро┤рпНроХрпНроХрпИ ро╡ро╛ро┤рпНро╡ро╛ро░рпНроХро│рпН. рооро╛роЩрпНроХро▓рпНроп рокро▓роорпН роЪро┐ро▒рокрпНрокрпБ.");
    } else {
        sections.push("**9. ро░роЬрпНроЬрпБрокрпН рокрпКро░рпБродрпНродроорпН тЭМ:** ЁЯЪи роЗродрпБ рооро┐роХ роорпБроХрпНроХро┐ропрооро╛рой рокрпКро░рпБродрпНродроорпН. ро░роЬрпНроЬрпБрокрпН рокрпКро░рпБродрпНродроорпН роЗро▓рпНро▓ро╛родродро╛ро▓рпН роЖропрпБро│рпН рокро▓роорпН, рооро╛роЩрпНроХро▓рпНроп рокро▓роорпН роХрпБро▒рпИропрпБроорпН. родрооро┐ро┤рпНроиро╛роЯрпБ роЬрпЛродро┐роЯродрпНродро┐ро▓рпН роЗродрпБ родро┐ро░рпБроорогродрпНродро┐ро▒рпНроХрпБ рооро┐роХрокрпН рокрпЖро░ро┐роп родроЯрпИропро╛роХроХрпН роХро░рпБродрокрпНрокроЯрпБроХро┐ро▒родрпБ.");
    }

    // Vedhai
    if (results.vedhai?.status === "Match") {
        sections.push("**10. ро╡рпЗродрпИрокрпН рокрпКро░рпБродрпНродроорпН тЬЕ:** роЗро░рпБро╡ро░ро┐ройрпН роироЯрпНроЪродрпНродро┐ро░роЩрпНроХро│рпБроХрпНроХрпБ роЗроЯрпИропрпЗ роОроирпНрод ро╡рпЗродрпИ (роОродро┐ро░рпНрокрпНрокрпБ) роЗро▓рпНро▓рпИ. ро╡ро╛ро┤рпНроХрпНроХрпИропро┐ро▓рпН роОродро┐ро░рпНрокро╛ро░ро╛род родроЯрпИроХро│рпН ро╡ро░ро╛родрпБ.");
    } else {
        sections.push("**10. ро╡рпЗродрпИрокрпН рокрпКро░рпБродрпНродроорпН тЭМ:** роироЯрпНроЪродрпНродро┐ро░ ро╡рпЗродрпИ роЙро│рпНро│родрпБ. роОродро┐ро░рпНрокро╛ро░ро╛род родроЯрпИроХро│рпН, ро╡роорпНрокрпБ ро╡ро┤роХрпНроХрпБроХро│рпН, роЕро▓рпНро▓родрпБ роЖро░рпЛроХрпНроХро┐роп рокро┐ро░роЪрпНроЪро┐ройрпИроХро│рпН ро╡ро░ро▓ро╛роорпН.");
    }

    // Nadi
    const bNadi = NADI_GROUPS[bStar?.id];
    const gNadi = NADI_GROUPS[gStar?.id];
    if (results.nadi?.status === "Match") {
        sections.push(`**11. роиро╛роЯро┐рокрпН рокрпКро░рпБродрпНродроорпН тЬЕ:** рокрпЖрогрпН ${NADI_NAMES[bNadi] || ''} роиро╛роЯро┐, роЖрогрпН ${NADI_NAMES[gNadi] || ''} роиро╛роЯро┐ тАФ ро╡рпЖро╡рпНро╡рпЗро▒рпБ роиро╛роЯро┐роХро│рпН роЗро░рпБрокрпНрокродро╛ро▓рпН роХрпБро┤роирпНродрпИроХро│ро┐ройрпН роЖро░рпЛроХрпНроХро┐ропроорпН роЪро┐ро▒рокрпНрокро╛роХ роЗро░рпБроХрпНроХрпБроорпН. рооро░рокрогрпБ ро░рпАродро┐ропро┐ро▓рпН роиро▓рпНро▓ рокрпКро░рпБродрпНродроорпН.`);
    } else {
        sections.push(`**11. роиро╛роЯро┐рокрпН рокрпКро░рпБродрпНродроорпН тЭМ:** роЗро░рпБро╡ро░рпБроорпН роТро░рпЗ роиро╛роЯро┐ (${NADI_NAMES[bNadi] || ''}) роЙроЯрпИропро╡ро░рпНроХро│рпН. родрооро┐ро┤рпН роЬрпЛродро┐роЯродрпНродро┐ро▓рпН роТро░рпЗ роиро╛роЯро┐ родро┐ро░рпБроорогроорпН родро╡ро┐ро░рпНроХрпНроХ ро╡рпЗрогрпНроЯрпБроорпН роОройрпНрокродрпБ ро╡ро┤роХрпНроХроорпН. роХрпБро┤роирпНродрпИроХро│ро┐ройрпН роЖро░рпЛроХрпНроХро┐ропродрпНродро┐ро▓рпН рокро╛родро┐рокрпНрокрпБ ро╡ро░ро▓ро╛роорпН.`);
    }

    // Vruksha
    sections.push("**12. ро╡ро┐ро░рпБроЯрпНроЪрокрпН рокрпКро░рпБродрпНродроорпН тЬЕ:** ро╡ро┐ро░рпБроЯрпНроЪ (рооро░) рокрпКро░рпБродрпНродроорпН роиройрпНро▒ро╛роХ роЙро│рпНро│родрпБ.");

    // ===================== SECTION 4: CHART ANALYSIS =====================
    if (hasCharts) {
        sections.push("## ЁЯФн роЬро╛родроХроХрпН роХроЯрпНроЯ роЖропрпНро╡рпБ (Chart Deep Analysis)");

        // 7th House Analysis
        sections.push("### ЁЯПа 7-роорпН ро╡рпАроЯрпБ (роХро▓родрпНродро┐ро░ ро╕рпНродро╛ройроорпН) роЖропрпНро╡рпБ");
        if (b7thHouse) {
            let b7text = `**рокрпЖрогрпН роЬро╛родроХроорпН:** 7-роорпН ро╡рпАроЯрпБ (${RASIS.find(r => r.id === b7thHouse.house)?.nameTamil || ''}) `;
            if (b7thHouse.isEmpty) b7text += "ро╡рпЖро▒рпНро▒ро┐роЯрооро╛роХ роЙро│рпНро│родрпБ тАФ рокрпКродрпБро╡ро╛рой родро┐ро░рпБроорог ро╡ро╛ро┤рпНроХрпНроХрпИ.";
            else if (b7thHouse.hasJupiter) b7text += "роХрпБро░рпБ рокроХро╡ро╛ройрпН роЗро░рпБрокрпНрокродро╛ро▓рпН роХрогро╡ройрпН роиро▓рпНро▓ро╡ро░ро╛роХро╡рпБроорпН роЕро▒ро┐ро╡ро╛ро│ро┐ропро╛роХро╡рпБроорпН роЗро░рпБрокрпНрокро╛ро░рпН.";
            else if (b7thHouse.hasVenus) b7text += "роЪрпБроХрпНроХро┐ро░ройрпН роЗро░рпБрокрпНрокродро╛ро▓рпН роЕро┤роХро╛рой, роХро╛родро▓рпН роиро┐ро▒рпИроирпНрод родро┐ро░рпБроорог ро╡ро╛ро┤рпНроХрпНроХрпИ роЕроорпИропрпБроорпН.";
            else if (b7thHouse.hasMars) b7text += "роЪрпЖро╡рпНро╡ро╛ропрпН роЗро░рпБрокрпНрокродро╛ро▓рпН роХрогро╡ройрпН родрпИро░ро┐ропрооро╛ройро╡ро░ро╛роХ роЗро░рпБрокрпНрокро╛ро░рпН, роЖройро╛ро▓рпН роЪро┐ро▒рпБ роорпЛродро▓рпНроХро│рпН ро╡ро░ро▓ро╛роорпН.";
            else if (b7thHouse.hasSaturn) b7text += "роЪройро┐ роЗро░рпБрокрпНрокродро╛ро▓рпН родро┐ро░рпБроорогроорпН родро╛роородрооро╛роХро▓ро╛роорпН роЕро▓рпНро▓родрпБ ро╡ропродрпБ ро╡рпЗро▒рпБрокро╛роЯрпБ роЙро│рпНро│ ро╡ро╛ро┤рпНроХрпНроХрпИродрпН родрпБрогрпИ роЕроорпИропро▓ро╛роорпН.";
            else if (b7thHouse.hasRahu) b7text += "ро░ро╛роХрпБ роЗро░рпБрокрпНрокродро╛ро▓рпН ро╡рпЖро│ро┐роиро╛роЯрпНроЯрпБродрпН родрпКроЯро░рпНрокрпБ роЕро▓рпНро▓родрпБ ро╡ро┤роХрпНроХрооро▒рпНро▒ родро┐ро░рпБроорогроорпН роироЯроХрпНроХро▓ро╛роорпН.";
            else if (b7thHouse.hasBenefic) b7text += "роЪрпБрок роХро┐ро░роХроЩрпНроХро│рпН роЗро░рпБрокрпНрокродро╛ро▓рпН роиро▓рпНро▓ родро┐ро░рпБроорог ро╡ро╛ро┤рпНроХрпНроХрпИ роЙро▒рпБродро┐.";
            else b7text += "рокро╛рок роХро┐ро░роХроЩрпНроХро│рпН роЗро░рпБрокрпНрокродро╛ро▓рпН ро╡ро╛ро┤рпНроХрпНроХрпИродрпН родрпБрогрпИропрпБроЯройрпН роЪро┐ро▓ роЪро╡ро╛ро▓рпНроХро│рпН роПро▒рпНрокроЯро▓ро╛роорпН.";
            sections.push(b7text);
        }
        if (g7thHouse) {
            let g7text = `**роЖрогрпН роЬро╛родроХроорпН:** 7-роорпН ро╡рпАроЯрпБ (${RASIS.find(r => r.id === g7thHouse.house)?.nameTamil || ''}) `;
            if (g7thHouse.isEmpty) g7text += "ро╡рпЖро▒рпНро▒ро┐роЯрооро╛роХ роЙро│рпНро│родрпБ тАФ рокрпКродрпБро╡ро╛рой родро┐ро░рпБроорог ро╡ро╛ро┤рпНроХрпНроХрпИ.";
            else if (g7thHouse.hasJupiter) g7text += "роХрпБро░рпБ рокроХро╡ро╛ройрпН роЗро░рпБрокрпНрокродро╛ро▓рпН рооройрпИро╡ро┐ роХрпБрогро╡родро┐ропро╛роХро╡рпБроорпН рокрпБродрпНродро┐роЪро╛ро▓ро┐ропро╛роХро╡рпБроорпН роЗро░рпБрокрпНрокро╛ро│рпН.";
            else if (g7thHouse.hasVenus) g7text += "роЪрпБроХрпНроХро┐ро░ройрпН роЗро░рпБрокрпНрокродро╛ро▓рпН роЕро┤роХро╛рой, роЖроХро░рпНро╖ро┐роХрпНроХрпБроорпН рооройрпИро╡ро┐ роЕроорпИро╡ро╛ро│рпН.";
            else if (g7thHouse.hasMars) g7text += "роЪрпЖро╡рпНро╡ро╛ропрпН роЗро░рпБрокрпНрокродро╛ро▓рпН рооройрпИро╡ро┐ родрпИро░ро┐ропрооро╛ройро╡ро│ро╛роХ роЗро░рпБрокрпНрокро╛ро│рпН, роЪро┐ро▒рпБ роорпЛродро▓рпНроХро│рпН ро╡ро░ро▓ро╛роорпН.";
            else if (g7thHouse.hasSaturn) g7text += "роЪройро┐ роЗро░рпБрокрпНрокродро╛ро▓рпН рокрпКро▒рпБроорпИропро╛рой рооройрпИро╡ро┐ роЕроорпИро╡ро╛ро│рпН, роЖройро╛ро▓рпН роЙро▒ро╡ро┐ро▓рпН роХрпБро│ро┐ро░рпНроЪрпНроЪро┐ роЗро░рпБроХрпНроХро▓ро╛роорпН.";
            else if (g7thHouse.hasRahu) g7text += "ро░ро╛роХрпБ роЗро░рпБрокрпНрокродро╛ро▓рпН ро╡ро┤роХрпНроХродрпНродро┐ро▒рпНроХрпБ рооро╛ро▒ро╛рой родро┐ро░рпБроорогроорпН роироЯроХрпНроХро▓ро╛роорпН.";
            else if (g7thHouse.hasBenefic) g7text += "роЪрпБрок роХро┐ро░роХроЩрпНроХро│рпН роЗро░рпБрокрпНрокродро╛ро▓рпН роиро▓рпНро▓ рооройрпИро╡ро┐ роЕроорпИро╡ро╛ро│рпН.";
            else g7text += "рокро╛рок роХро┐ро░роХроЩрпНроХро│рпН роЗро░рпБрокрпНрокродро╛ро▓рпН рооройрпИро╡ро┐ропрпБроЯройрпН роЪро┐ро▓ роЪро╡ро╛ро▓рпНроХро│рпН роПро▒рпНрокроЯро▓ро╛роорпН.";
            sections.push(g7text);
        }

        // Sevvai Dosham
        sections.push("### ЁЯФ┤ роЪрпЖро╡рпНро╡ро╛ропрпН родрпЛро╖роорпН (Mars Dosha / Manglik)");
        if (bSevvai?.hasDosham && gSevvai?.hasDosham) {
            sections.push("роЗро░рпБро╡ро░рпБроХрпНроХрпБроорпН роЪрпЖро╡рпНро╡ро╛ропрпН родрпЛро╖роорпН роЙро│рпНро│родрпБ тАФ **роЪрпЖро╡рпНро╡ро╛ропрпН родрпЛро╖роорпН роЪрпЖро╡рпНро╡ро╛ропрпН родрпЛро╖родрпНродрпИ ро░родрпНродрпБ роЪрпЖропрпНропрпБроорпН** (Manglik matches Manglik). роОройро╡рпЗ роЗродрпБ рокро┐ро░роЪрпНроЪро┐ройрпИропро▓рпНро▓. родро┐ро░рпБроорогроорпН роироЯроХрпНроХро▓ро╛роорпН.");
        } else if (bSevvai?.hasDosham && !gSevvai?.hasDosham) {
            sections.push(`тЪая╕П рокрпЖрогрпНрогрпБроХрпНроХрпБ роЪрпЖро╡рпНро╡ро╛ропрпН родрпЛро╖роорпН роЙро│рпНро│родрпБ (${bSevvai.severity === 'severe' ? 'родрпАро╡ро┐ро░роорпН' : 'ро▓рпЗроЪро╛ройродрпБ'} тАФ ро╡рпАроЯрпБроХро│рпН: ${bSevvai.houses.join(', ')}). роЖрогрпБроХрпНроХрпБ роЗро▓рпНро▓рпИ. роЗродрпБ роХрогро╡ройро┐ройрпН роЖро░рпЛроХрпНроХро┐ропроорпН рооро▒рпНро▒рпБроорпН роЖропрпБро│рпИ рокро╛родро┐роХрпНроХро▓ро╛роорпН. рокро░ро┐роХро╛ро░роорпН роЕро╡роЪро┐ропроорпН.`);
        } else if (!bSevvai?.hasDosham && gSevvai?.hasDosham) {
            sections.push(`тЪая╕П роЖрогрпБроХрпНроХрпБ роЪрпЖро╡рпНро╡ро╛ропрпН родрпЛро╖роорпН роЙро│рпНро│родрпБ (${gSevvai.severity === 'severe' ? 'родрпАро╡ро┐ро░роорпН' : 'ро▓рпЗроЪро╛ройродрпБ'} тАФ ро╡рпАроЯрпБроХро│рпН: ${gSevvai.houses.join(', ')}). рокрпЖрогрпНрогрпБроХрпНроХрпБ роЗро▓рпНро▓рпИ. роЗродрпБ рооройрпИро╡ро┐ропро┐ройрпН роЖро░рпЛроХрпНроХро┐ропродрпНродрпИ рокро╛родро┐роХрпНроХро▓ро╛роорпН. рокро░ро┐роХро╛ро░роорпН роЕро╡роЪро┐ропроорпН.`);
        } else {
            sections.push("тЬЕ роЗро░рпБро╡ро░рпБроХрпНроХрпБроорпН роЪрпЖро╡рпНро╡ро╛ропрпН родрпЛро╖роорпН роЗро▓рпНро▓рпИ тАФ роЗродрпБ рооро┐роХро╡рпБроорпН роиро▓рпНро▓ роЕро▒ро┐роХрпБро▒ро┐. родро┐ро░рпБроорог ро╡ро╛ро┤рпНроХрпНроХрпИ роЪрпБроорпБроХрооро╛роХ роЗро░рпБроХрпНроХрпБроорпН.");
        }

        // Papasamyam
        sections.push("### тЪЦя╕П рокро╛рокроЪро╛роорпНропроорпН (Dosha Balance)");
        if (groomPapasamyam.points >= bridePapasamyam.points) {
            sections.push(`роЖрогро┐ройрпН родрпЛро╖ роЕро│ро╡рпБ (${groomPapasamyam.points}) рокрпЖрогрпНрогро┐ройрпН родрпЛро╖ роЕро│ро╡рпИ (${bridePapasamyam.points}) ро╡ро┐роЯ роЪроорооро╛роХ роЕро▓рпНро▓родрпБ роЕродро┐роХрооро╛роХ роЙро│рпНро│родрпБ. **родрооро┐ро┤рпН роЬрпЛродро┐роЯрокрпНрокроЯро┐ роЗродрпБ роЪро░ро┐ропро╛рой роЪроороиро┐ро▓рпИ.** родрпЛро╖роЩрпНроХро│рпН роТройрпНро▒рпИропрпКройрпНро▒рпБ ро░родрпНродрпБ роЪрпЖропрпНродрпБ роиройрпНроорпИроХро│рпН роироЯроХрпНроХрпБроорпН.`);
        } else {
            sections.push(`тЪая╕П рокрпЖрогрпНрогро┐ройрпН родрпЛро╖ роЕро│ро╡рпБ (${bridePapasamyam.points}) роЖрогро┐ройрпН родрпЛро╖ роЕро│ро╡рпИ (${groomPapasamyam.points}) ро╡ро┐роЯ роЕродро┐роХроорпН. **роЗродрпБ роЪро░ро┐ропро╛рой роЪроороиро┐ро▓рпИ роЕро▓рпНро▓.** родро┐ро░рпБроорог ро╡ро╛ро┤рпНро╡ро┐ро▓рпН роЪро╡ро╛ро▓рпНроХро│рпН ро╡ро░ро▓ро╛роорпН. роиро╡роХрпНроХро┐ро░роХ ро╣рпЛроороорпН роЪрпЖропрпНро╡родрпБ роиро▓рпНро▓родрпБ.`);
        }

        // Navamsam
        sections.push("### ЁЯМЩ роиро╡ро╛роорпНроЪроорпН (D9 Chart) роЖропрпНро╡рпБ");
        if (bNavamsa.isGood && gNavamsa.isGood) {
            sections.push("роЗро░рпБро╡ро░ро┐ройрпН роиро╡ро╛роорпНроЪродрпНродро┐ро▓рпБроорпН 7-роорпН ро╡рпАроЯрпБ роЪро┐ро▒рокрпНрокро╛роХ роЙро│рпНро│родрпБ. роХрогро╡ройрпН-рооройрпИро╡ро┐ роЙро▒ро╡рпБ роЖро┤рооро╛роХро╡рпБроорпН, роиро┐ро▓рпИропро╛ройродро╛роХро╡рпБроорпН роЗро░рпБроХрпНроХрпБроорпН. ро╡ро╛ро┤рпНроХрпНроХрпИропро┐ройрпН роЗро░рогрпНроЯро╛роорпН рокро╛родро┐ропро┐ро▓рпН роорпЗро▓рпБроорпН роирпЖро░рпБроХрпНроХроорпН роЕродро┐роХро░ро┐роХрпНроХрпБроорпН.");
        } else if (!bNavamsa.isGood && !gNavamsa.isGood) {
            sections.push("тЪая╕П роЗро░рпБро╡ро░ро┐ройрпН роиро╡ро╛роорпНроЪродрпНродро┐ро▓рпБроорпН 7-роорпН ро╡рпАроЯрпНроЯро┐ро▓рпН рокро╛рок роХро┐ро░роХроЩрпНроХро│рпН роЙро│рпНро│┬нрой. роХрогро╡ройрпН-рооройрпИро╡ро┐ роЙро▒ро╡ро┐ро▓рпН роЪро╡ро╛ро▓рпНроХро│рпН роЗро░рпБроХрпНроХрпБроорпН. рокрпКро▒рпБроорпИропрпБроорпН рокрпБро░ро┐родро▓рпБроорпН рооро┐роХ роЕро╡роЪро┐ропроорпН.");
        } else {
            sections.push(`${!bNavamsa.isGood ? 'рокрпЖрогрпНрогро┐ройрпН' : 'роЖрогро┐ройрпН'} роиро╡ро╛роорпНроЪ 7-роорпН ро╡рпАроЯрпНроЯро┐ро▓рпН рокро╛рок роХро┐ро░роХроЩрпНроХро│рпН роЙро│рпНро│рой. ${bNavamsa.isGood ? 'рокрпЖрогрпНрогро┐ройрпН' : 'роЖрогро┐ройрпН'} роиро╡ро╛роорпНроЪроорпН роЪро┐ро▒рокрпНрокро╛роХ роЙро│рпНро│родрпБ. роЪро┐ро▒рпБ роЪро╡ро╛ро▓рпНроХро│рпН роЗро░рпБроирпНродро╛ро▓рпБроорпН роТроЯрпНроЯрпБроорпКродрпНродрооро╛роХ роиро▓рпНро▓ ро╡ро╛ро┤рпНроХрпНроХрпИ роЕроорпИропрпБроорпН.`);
        }
    } else {
        sections.push("## ЁЯУМ роХрпБро▒ро┐рокрпНрокрпБ");
        sections.push("роЬро╛родроХроХрпН роХроЯрпНроЯроЩрпНроХро│рпН (Rasi Chart / Navamsam) роЙро│рпНро│ро┐роЯрокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ. роОройро╡рпЗ 7-роорпН ро╡рпАроЯрпНроЯрпБ роЖропрпНро╡рпБ, роЪрпЖро╡рпНро╡ро╛ропрпН родрпЛро╖роорпН, рокро╛рокроЪро╛роорпНропроорпН, роиро╡ро╛роорпНроЪ роЖропрпНро╡рпБ роЖроХро┐ропро╡рпИ роХрогро┐роХрпНроХрокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ. родрпБро▓рпНро▓ро┐ропрооро╛рой роХрогро┐рокрпНрокрпБроХрпНроХрпБ роЬро╛родроХроХрпН роХроЯрпНроЯроЩрпНроХро│рпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН.");
    }

    // ===================== SECTION 5: MARRIAGE LIFE STORY =====================
    sections.push("## ЁЯУЦ родро┐ро░рпБроорог ро╡ро╛ро┤рпНроХрпНроХрпИ роХродрпИ (Marriage Life Story)");

    // Build flowing narrative
    let story = "";
    if (results.rajju.status === "Match" && importantMatches >= 3) {
        story += `${bride.name || 'рокрпЖрогрпН'} рооро▒рпНро▒рпБроорпН ${groom.name || 'роЖрогрпН'} роЖроХро┐роп роЗро░рпБро╡ро░ро┐ройрпН роЬро╛родроХродрпНродрпИ роЖро░ро╛ропрпНроирпНродродро┐ро▓рпН, роЗроирпНродродрпН родро┐ро░рпБроорогроорпН роиро▓рпНро▓ рокрпКро░рпБродрпНродродрпНродрпБроЯройрпН роЕроорпИро╡родро╛роХродрпН родрпЖро░ро┐роХро┐ро▒родрпБ.\n\n`;
        story += "**роорпБродро▓рпН роЖрогрпНроЯрпБ:** родро┐ро░рпБроорогродрпНродро┐ройрпН роЖро░роорпНрок роХро╛ро▓роЩрпНроХро│ро┐ро▓рпН роЗро░рпБро╡ро░рпБроХрпНроХрпБроорпН роЗроЯрпИропрпЗ роиро▓рпНро▓ рокрпБро░ро┐родро▓рпН роЗро░рпБроХрпНроХрпБроорпН. ";
        if (results.gana.status === "Match") story += "роЗро░рпБро╡ро░ро┐ройрпН роХрпБрогроорпБроорпН роТродрпНродрпБро╡ро░рпБро╡родро╛ро▓рпН роЕройрпНропрпЛройрпНропроорпН роиро┐ро▓рпИродрпНродро┐ро░рпБроХрпНроХрпБроорпН. ";
        else story += "роХрпБрогроиро▓ройрпНроХро│ро┐ро▓рпН роЪро┐ро▒рпБ ро╡рпЗро▒рпБрокро╛роЯрпБроХро│рпН роЗро░рпБроирпНродро╛ро▓рпБроорпН роХро╛ро▓рокрпНрокрпЛроХрпНроХро┐ро▓рпН роТро░рпБро╡ро░рпИ роТро░рпБро╡ро░рпН рокрпБро░ро┐роирпНродрпБроХрпКро│рпНро╡ро╛ро░рпНроХро│рпН. ";
        if (results.yoni.status === "Match") story += "родро╛роорпНрокродрпНродро┐роп ро╡ро╛ро┤рпНроХрпНроХрпИ роЗройро┐роорпИропро╛роХ роЗро░рпБроХрпНроХрпБроорпН.\n\n";
        else story += "родро╛роорпНрокродрпНродро┐роп ро╡ро╛ро┤рпНро╡ро┐ро▓рпН роЪро┐ро▓ роПро▒рпНро▒ роЗро▒роХрпНроХроЩрпНроХро│рпН роЗро░рпБроХрпНроХро▓ро╛роорпН, роЖройро╛ро▓рпН рокро░ро╕рпНрокро░ рокрпБро░ро┐родро▓рпН роЗро░рпБроирпНродро╛ро▓рпН роЪрооро╛ро│ро┐роХрпНроХро▓ро╛роорпН.\n\n";

        story += "**роХрпБро┤роирпНродрпИ рокро╛роХрпНроХро┐ропроорпН:** ";
        if (results.mahendra.status === "Match" && results.nadi?.status === "Match") story += "рокрпБродрпНродро┐ро░ рокро╛роХрпНроХро┐ропроорпН роЪро┐ро▒рокрпНрокро╛роХ роЕроорпИропрпБроорпН. роЖро░рпЛроХрпНроХро┐ропрооро╛рой, роЕро▒ро┐ро╡рпБроХрпНроХрпВро░рпНроорпИ роХрпКрогрпНроЯ роХрпБро┤роирпНродрпИроХро│рпН рокро┐ро▒роХрпНроХрпБроорпН ро╡ро╛ропрпНрокрпНрокрпБ роЙро│рпНро│родрпБ.\n\n";
        else if (results.mahendra.status === "Match") story += "роХрпБро┤роирпНродрпИроХро│рпН рокро┐ро▒роХрпНроХрпБроорпН ро╡ро╛ропрпНрокрпНрокрпБ роиройрпНро▒ро╛роХ роЙро│рпНро│родрпБ. роЖройро╛ро▓рпН роЖро░рпЛроХрпНроХро┐ропродрпНродро┐ро▓рпН роХро╡ройроорпН родрпЗро╡рпИ.\n\n";
        else story += "роХрпБро┤роирпНродрпИ рокро╛роХрпНроХро┐ропроорпН роЪро▒рпНро▒рпБ родро╛роородрооро╛роХро▓ро╛роорпН. роХрпБро▓родрпЖропрпНро╡ ро╡ро┤ро┐рокро╛роЯрпБ рооро▒рпНро▒рпБроорпН роЪроирпНродро╛рой роХрпЛрокро╛ро▓ роороирпНродро┐ро░роорпН роЬрпЖрокро┐рокрпНрокродрпБ роиро▓рпНро▓родрпБ.\n\n";

        story += "**рокрпКро░рпБро│ро╛родро╛ро░роорпН:** ";
        if (results.rasi.status === "Match" && results.rasiAthipathi.status === "Match") story += "роХрпБроЯрпБроорпНрокродрпНродро┐ройрпН рокрпКро░рпБро│ро╛родро╛ро░ роиро┐ро▓рпИ роиро╛ро│рпБроХрпНроХрпБ роиро╛ро│рпН роЙропро░рпБроорпН. роХрогро╡ройрпН-рооройрпИро╡ро┐ роЗро░рпБро╡ро░рпБроорпН роЪрпЗро░рпНроирпНродрпБ роЪроорпНрокро╛родро┐роХрпНроХрпБроорпН ропрпЛроХроорпН роЙро│рпНро│родрпБ. роЪрпКродрпНродрпБ роЪрпЗро░рпНроХрпНроХрпИ, ро╡рпАроЯрпБ роХроЯрпНроЯрпБродро▓рпН рокрпЛройрпНро▒ро╡рпИ роироЯроХрпНроХрпБроорпН.\n\n";
        else story += "рокрпКро░рпБро│ро╛родро╛ро░родрпНродро┐ро▓рпН роПро▒рпНро▒ роЗро▒роХрпНроХроЩрпНроХро│рпН ро╡ро░ро▓ро╛роорпН. роЖройро╛ро▓рпН роХроЯро┐рой роЙро┤рпИрокрпНрокрпБ рооро▒рпНро▒рпБроорпН роЪро┐роХрпНроХройродрпНродро╛ро▓рпН роиро┐ро▓рпИропро╛рой ро╡ро╛ро┤рпНроХрпНроХрпИ роЕроорпИрокрпНрокро╛ро░рпНроХро│рпН.\n\n";

        story += "**ро╡ропродро╛рой роХро╛ро▓роорпН:** ро░роЬрпНроЬрпБрокрпН рокрпКро░рпБродрпНродроорпН роЪро┐ро▒рокрпНрокро╛роХ роЗро░рпБрокрпНрокродро╛ро▓рпН роЗро░рпБро╡ро░рпБроорпН роирпАрогрпНроЯ роЖропрпБро│рпБроЯройрпН, рокрпЗро░роХрпНроХрпБро┤роирпНродрпИроХро│ро┐ройрпН роЪроирпНродрпЛро╖родрпНродрпИ роЕройрпБрокро╡ро┐родрпНродрпБ, роиро┐роорпНроородро┐ропро╛рой ро╡ропродро╛рой роХро╛ро▓родрпНродрпИ роХро┤ро┐рокрпНрокро╛ро░рпНроХро│рпН.";
    } else if (results.rajju.status === "No Match") {
        story += `${bride.name || 'рокрпЖрогрпН'} рооро▒рпНро▒рпБроорпН ${groom.name || 'роЖрогрпН'} роЖроХро┐роп роЗро░рпБро╡ро░ро┐ройрпН роЬро╛родроХродрпНродрпИ роЖро░ро╛ропрпНроирпНродродро┐ро▓рпН, **ро░роЬрпНроЬрпБрокрпН рокрпКро░рпБродрпНродроорпН роЗро▓рпНро▓ро╛родродро╛ро▓рпН роЗроирпНродродрпН родро┐ро░рпБроорогроорпН роЙроХроирпНродродро▓рпНро▓** роОройрпНрокродрпБ родрооро┐ро┤рпНроиро╛роЯрпБ роЬрпЛродро┐роЯ рооро░рокрпБрокрпНрокроЯро┐ родрпЖро│ро┐ро╡ро╛роХродрпН родрпЖро░ро┐роХро┐ро▒родрпБ.\n\n`;
        story += "ро░роЬрпНроЬрпБрокрпН рокрпКро░рпБродрпНродроорпН роОройрпНрокродрпБ рооро╛роЩрпНроХро▓рпНроп рокро▓родрпНродрпИропрпБроорпН роХрогро╡ройрпН-рооройрпИро╡ро┐ роЖропрпБро│рпН рокро▓родрпНродрпИропрпБроорпН роХрпБро▒ро┐роХрпНроХро┐ро▒родрпБ. роЗродрпБ роЗро▓рпНро▓ро╛рооро▓рпН родро┐ро░рпБроорогроорпН роЪрпЖропрпНро╡родрпБ родрооро┐ро┤рпН роЬрпЛродро┐роЯродрпНродро┐ро▓рпН рооро┐роХрокрпН рокрпЖро░ро┐роп родроЯрпИропро╛роХроХрпН роХро░рпБродрокрпНрокроЯрпБроХро┐ро▒родрпБ.\n\n";
        story += "роЗро░рпБрокрпНрокро┐ройрпБроорпН, рокро░ро┐роХро╛ро░роЩрпНроХро│рпН роЪрпЖропрпНрод рокро┐ройрпНройро░рпН роорпАрогрпНроЯрпБроорпН роЬрпЛродро┐роЯро░ро┐роЯроорпН роЖро▓рпЛроЪройрпИ рокрпЖро▒рпБро╡родрпБ роиро▓рпНро▓родрпБ. роЪро┐ро▓ роЪрооропроорпН рооро▒рпНро▒ рокрпКро░рпБродрпНродроЩрпНроХро│рпН ро╡ро▓рпБро╡ро╛роХ роЗро░рпБроирпНродро╛ро▓рпН ро░роЬрпНроЬрпБ родрпЛро╖ рокро░ро┐роХро╛ро░родрпНродрпБроЯройрпН родро┐ро░рпБроорогроорпН роироЯродрпНродро▓ро╛роорпН роОройрпНрокродрпБроорпН роЙрогрпНроЯрпБ.";
    } else {
        story += `${bride.name || 'рокрпЖрогрпН'} рооро▒рпНро▒рпБроорпН ${groom.name || 'роЖрогрпН'} роЖроХро┐роп роЗро░рпБро╡ро░ро┐ройрпН роЬро╛родроХродрпНродрпИ роЖро░ро╛ропрпНроирпНродродро┐ро▓рпН, роЗроирпНродродрпН родро┐ро░рпБроорогроорпН роородрпНродро┐ропроорооро╛рой рокрпКро░рпБродрпНродродрпНродрпБроЯройрпН роЕроорпИро╡родро╛роХродрпН родрпЖро░ро┐роХро┐ро▒родрпБ.\n\n`;
        story += "**роорпБродро▓рпН роЖрогрпНроЯрпБ:** родро┐ро░рпБроорогродрпНродро┐ройрпН роЖро░роорпНрокродрпНродро┐ро▓рпН роЪро┐ро▓ роЪро╡ро╛ро▓рпНроХро│рпН ро╡ро░ро▓ро╛роорпН. роТро░рпБро╡ро░рпИ роТро░рпБро╡ро░рпН рокрпБро░ро┐роирпНродрпБроХрпКро│рпНро│ роирпЗро░роорпН роЖроХрпБроорпН. рокрпКро▒рпБроорпИропрпБроорпН ро╡ро┐роЯрпНроЯрпБроХрпНроХрпКроЯрпБрокрпНрокрпБроорпН роЕро╡роЪро┐ропроорпН.\n\n";
        story += "**роХрпБро┤роирпНродрпИ рокро╛роХрпНроХро┐ропроорпН:** ";
        if (results.mahendra.status === "Match") story += "рокрпБродрпНродро┐ро░ рокро╛роХрпНроХро┐ропроорпН роиройрпНро▒ро╛роХ роЗро░рпБроХрпНроХрпБроорпН.\n\n";
        else story += "роХрпБро┤роирпНродрпИ рокро╛роХрпНроХро┐ропродрпНродро┐ро▓рпН родро╛роородроорпН роПро▒рпНрокроЯро▓ро╛роорпН. роХрпБро▓родрпЖропрпНро╡ ро╡ро┤ро┐рокро╛роЯрпБ рокро░ро┐роирпНродрпБро░рпИроХрпНроХрокрпНрокроЯрпБроХро┐ро▒родрпБ.\n\n";
        story += "**рокрпКро░рпБро│ро╛родро╛ро░роорпН:** роХроЯро┐рой роЙро┤рпИрокрпНрокро╛ро▓рпН роиро┐ро▓рпИропро╛рой ро╡ро╛ро┤рпНроХрпНроХрпИ роЕроорпИроХрпНроХро▓ро╛роорпН. роЖройро╛ро▓рпН роОродро┐ро░рпНрокро╛ро░ро╛род роЪрпЖро▓ро╡рпБроХро│рпН ро╡ро░ро▓ро╛роорпН.\n\n";
        story += "**ро╡ропродро╛рой роХро╛ро▓роорпН:** рокрпКро░рпБродрпНродроХрпН роХрпБро▒рпИрокро╛роЯрпБроХро│рпН роЗро░рпБроирпНродро╛ро▓рпБроорпН, роЗро░рпБро╡ро░рпБроорпН роТро░рпБро╡ро░рпБроХрпНроХрпКро░рпБро╡ро░рпН роЖродро░ро╡ро╛роХ роЗро░рпБроирпНродро╛ро▓рпН роиро┐роорпНроородро┐ропро╛рой ро╡ро╛ро┤рпНроХрпНроХрпИ ро╡ро╛ро┤ро▓ро╛роорпН.";
    }
    sections.push(story);

    // ===================== SECTION 6: REMEDIES =====================
    const doshamResult = { match: (groomPapasamyam.points >= bridePapasamyam.points) || (bridePapasamyam.points < 3 && groomPapasamyam.points < 3) ? "Match" : "No Match" };
    const remedies = generatePariharam(results, hasCharts, bSevvai, gSevvai, doshamResult, bNavamsa, gNavamsa);
    sections.push("## ЁЯЩП рокро░ро┐роХро╛ро░роорпН (Remedies)");
    remedies.forEach(r => sections.push(r));

    return sections.join("\n\n");
};

export const calculatePorutham = (bride, groom) => {
    const bStar = STARS.find(s => s.id === parseInt(bride.starId));
    const gStar = STARS.find(s => s.id === parseInt(groom.starId));
    const bRasi = RASIS.find(r => r.id === parseInt(bride.rasiId));
    const gRasi = RASIS.find(r => r.id === parseInt(groom.rasiId));

    if (!bStar || !gStar || !bRasi || !gRasi) return null;

    const results = {};

    // 1. Dina Porutham
    const starDist = (gStar.id - bStar.id + 27) % 9;
    const dinaGood = [2, 4, 6, 8, 0].includes(starDist);
    results.dina = { name: "родро┐ройрокрпН рокрпКро░рпБродрпНродроорпН", status: dinaGood ? "Match" : "No Match", score: dinaGood ? 1 : 0 };

    // 2. Gana Porutham
    let ganaScore = 0;
    if (bStar.gana === gStar.gana) ganaScore = 1;
    else if (bStar.gana === "Deva" && gStar.gana === "Manushya") ganaScore = 1;
    else if (bStar.gana === "Manushya" && gStar.gana === "Deva") ganaScore = 0.5;
    else if (gStar.gana === "Rakshasa") ganaScore = 0;
    else ganaScore = 0;
    results.gana = { name: "роХрогрокрпН рокрпКро░рпБродрпНродроорпН", status: ganaScore >= 0.5 ? "Match" : "No Match", score: Math.ceil(ganaScore) };

    // 3. Mahendra Porutham (Important)
    const distMahendra = (gStar.id - bStar.id + 27);
    const mahendraGood = [4, 7, 10, 13, 16, 19, 22, 25].includes(distMahendra % 27) || [4, 7, 10, 13, 16, 19, 22, 25].includes(distMahendra);
    results.mahendra = { name: "рооро╛роХрпЗроирпНродро┐ро░рокрпН рокрпКро░рпБродрпНродроорпН", status: mahendraGood ? "Match" : "No Match", score: mahendraGood ? 1 : 0 };

    // 4. Sthree Dheerkha
    const sthreeDist = (gStar.id - bStar.id + 27) % 27;
    const sthreeGood = sthreeDist > 13;
    results.sthree = { name: "ро╕рпНродро┐ро░рпА родрпАро░рпНроХрпНроХроорпН", status: sthreeGood ? "Match" : "No Match", score: sthreeGood ? 1 : 0 };

    // 5. Yoni Porutham (Important)
    const isEnemy = YONI_ENEMIES[bStar.yoni] === gStar.yoni || YONI_ENEMIES[gStar.yoni] === bStar.yoni;
    results.yoni = { name: "ропрпЛройро┐рокрпН рокрпКро░рпБродрпНродроорпН", status: !isEnemy ? "Match" : "No Match", score: !isEnemy ? 1 : 0 };

    // 6. Rasi Porutham (Important)
    const rasiDist = (gRasi.id - bRasi.id + 12) % 12;
    const rasiGood = [0, 6, 2, 3, 9, 10].includes(rasiDist); // 1, 7, 3, 4, 10, 11 positions
    results.rasi = { name: "роЗро░ро╛роЪро┐рокрпН рокрпКро░рпБродрпНродроорпН", status: rasiGood ? "Match" : "No Match", score: rasiGood ? 1 : 0 };

    // 7. Rasi Athipathi (Important)
    const bLord = bRasi.lord;
    const gLord = gRasi.lord;
    const isFriend = (PLANET_FRIENDS[bLord] || []).includes(gLord) || (PLANET_FRIENDS[gLord] || []).includes(bLord) || bLord === gLord;
    results.rasiAthipathi = { name: "роЗро░ро╛роЪро┐ роЕродро┐рокродро┐ рокрпКро░рпБродрпНродроорпН", status: isFriend ? "Match" : "No Match", score: isFriend ? 1 : 0 };

    // 8. Vasya Porutham (Proper calculation)
    const bVasyaList = VASYA_DATA[bRasi.id] || [];
    const gVasyaList = VASYA_DATA[gRasi.id] || [];
    const vasyaMatch = bVasyaList.includes(gRasi.id) || gVasyaList.includes(bRasi.id) || bRasi.id === gRasi.id;
    results.vasya = { name: "ро╡роЪро┐ропрокрпН рокрпКро░рпБродрпНродроорпН", status: vasyaMatch ? "Match" : "No Match", score: vasyaMatch ? 1 : 0 };

    // 9. Rajju Porutham (MOST IMPORTANT)
    const rajjuGood = bStar.rajju !== gStar.rajju;
    results.rajju = { name: "ро░роЬрпНроЬро┐рокрпН рокрпКро░рпБродрпНродроорпН", status: rajjuGood ? "Match" : "No Match", score: rajjuGood ? 1 : 0 };

    // 10. Vedhai Porutham
    const isVedhai = bStar.vedhai === gStar.nameEnglish || gStar.vedhai === bStar.nameEnglish;
    results.vedhai = { name: "ро╡рпЗродрпИрокрпН рокрпКро░рпБродрпНродроорпН", status: !isVedhai ? "Match" : "No Match", score: !isVedhai ? 1 : 0 };

    // 11. Nadi Porutham (Proper calculation - same Nadi = No Match)
    const bNadi = NADI_GROUPS[bStar.id];
    const gNadi = NADI_GROUPS[gStar.id];
    const nadiMatch = bNadi !== gNadi;
    results.nadi = { name: "роиро╛роЯро┐рокрпН рокрпКро░рпБродрпНродроорпН", status: nadiMatch ? "Match" : "No Match", score: nadiMatch ? 1 : 0 };

    // 12. Vruksha Porutham
    results.vruksha = { name: "ро╡ро┐ро░рпБроЯрпНроЪрокрпН рокрпКро░рпБродрпНродроорпН", status: "Match", score: 1 };

    // --- AstroSage Advanced Analysis (Planetary Dosham) ---
    const bVenus = getPlanetHouse(bride.rasiChart, ['Ve', 'роЪрпБ']);
    const gVenus = getPlanetHouse(groom.rasiChart, ['Ve', 'роЪрпБ']);
    const bLagna = getPlanetHouse(bride.rasiChart, ['La', 'ро▓роХрпН']) || parseInt(bride.rasiId);
    const gLagna = getPlanetHouse(groom.rasiChart, ['La', 'ро▓роХрпН']) || parseInt(groom.rasiId);

    const bDosham = calculatePapasamyam(bride.rasiChart, bLagna, parseInt(bride.rasiId), bVenus);
    const gDosham = calculatePapasamyam(groom.rasiChart, gLagna, parseInt(groom.rasiId), gVenus);

    // AstroSage Rule: Groom Dosham must be >= Bride Dosham
    // Also consider it a match if both are low (< 3 points dosham)
    const doshamMatch = (gDosham.points >= bDosham.points) || (bDosham.points < 3 && gDosham.points < 3);

    const hasCharts = (bride.rasiChart && Object.keys(bride.rasiChart).length > 0) || (groom.rasiChart && Object.keys(groom.rasiChart).length > 0);

    const doshamResult = {
        bride: bDosham,
        groom: gDosham,
        match: hasCharts ? (doshamMatch ? "Match" : "No Match") : "Neutral",
        recommendation: hasCharts
            ? (doshamMatch
                ? "рокро╛рокроЪро╛роорпНропроорпН (Dosha Equivalency) роиройрпНроХрпБ рокрпКро░рпБроирпНродро┐ропрпБро│рпНро│родрпБ."
                : "рокрпЖрогрпНрогро┐ройрпН роЬро╛родроХрокрпН рокро╛рокрокрпН рокро▓ройрпН роЖрогро┐ройрпН роЬро╛родроХродрпНродрпИ ро╡ро┐роЯ роЕродро┐роХроорпН. роЗродрпБ родро┐ро░рпБроорогродрпНродро┐ро▒рпНроХрпБ роЙроХроирпНродродро▓рпНро▓.")
            : "роХроЯрпНроЯроЩрпНроХро│рпН роЗро▓рпНро▓ро╛родродро╛ро▓рпН рокро╛рокроЪро╛роорпНропроорпН роЕро▒ро┐ропрокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ."
    };

    // Navamsam
    const bNavamsa = analyzeNavamsam7th(bride.navamsamChart, bLagna);
    const gNavamsa = analyzeNavamsam7th(groom.navamsamChart, gLagna);

    // Final Recommendation
    const importantFields = ['rasi', 'rasiAthipathi', 'rajju', 'mahendra', 'yoni'];
    const importantMatches = importantFields.filter(f => results[f].status === "Match").length;

    // Custom logic: Rajju MUST match.
    let recommendation = "";
    let canMarry = false;

    if (results.rajju.status === "No Match") {
        recommendation = "ро░роЬрпНроЬро┐рокрпН рокрпКро░рпБродрпНродроорпН роЪро░ро┐ропро╛роХ роЗро▓рпНро▓рпИ (роЖропрпБро│рпН рокро▓роорпН роЗро▓рпНро▓рпИ). роЗродрпБ родро┐ро░рпБроорогродрпНродро┐ро▒рпНроХрпБ роЙроХроирпНродродро▓рпНро▓.";
        canMarry = false;
    } else if (hasCharts && doshamResult.match === "No Match") {
        recommendation = "рокрпЖрогрпНрогро┐ройрпН роЬро╛родроХродрпНродро┐ро▓рпН рокро╛рок роХро┐ро░роХрокрпН рокро▓ройрпН роЕродро┐роХрооро╛роХ роЙро│рпНро│родрпБ, роОройро╡рпЗ рокро╛рокроЪро╛роорпНропроорпН роЗро▓рпНро▓рпИ.";
        canMarry = false;
    } else if (importantMatches >= 3) {
        recommendation = `роорпБроХрпНроХро┐ропрооро╛рой 5 рокрпКро░рпБродрпНродроЩрпНроХро│ро┐ро▓рпН ${importantMatches} рокрпКро░рпБродрпНродроЩрпНроХро│рпН роЙро│рпНро│рой. роиро▓рпНро▓ рокрпКро░рпБродрпНродроорпН роЙрогрпНроЯрпБ.`;
        canMarry = true;
    } else {
        recommendation = `роорпБроХрпНроХро┐ропрооро╛рой 5 рокрпКро░рпБродрпНродроЩрпНроХро│ро┐ро▓рпН ${importantMatches} роороЯрпНроЯрпБроорпЗ роЙро│рпНро│рой. рокрпКро░рпБродрпНродроорпН роХрпБро▒рпИро╡ро╛роХ роЙро│рпНро│родрпБ.`;
        canMarry = false;
    }

    // --- Accurate Summary Report ---
    const pros = [];
    const cons = [];

    // Check Big 5 (The most important Poruthams)
    if (results.rajju.status === "Match") pros.push("ро░роЬрпНроЬро┐рокрпН рокрпКро░рпБродрпНродроорпН рооро┐роХроЪрпН роЪро┐ро▒рокрпНрокро╛роХ роЙро│рпНро│родрпБ (роЖропрпБро│рпН рооро▒рпНро▒рпБроорпН рооро╛роЩрпНроХро▓рпНроп рокро▓роорпН).");
    else cons.push("роорпБроХрпНроХро┐ропрооро╛рой ро░роЬрпНроЬро┐рокрпН рокрпКро░рпБродрпНродроорпН роЗро▓рпНро▓рпИ - роЗродрпБ рооро╛роЩрпНроХро▓рпНроп рокро▓роорпН рооро▒рпНро▒рпБроорпН роЖропрпБро│рпИрокрпН рокро╛родро┐роХрпНроХрпБроорпН.");

    if (results.rasi.status === "Match") pros.push("роЗро░ро╛роЪро┐рокрпН рокрпКро░рпБродрпНродроорпН роиройрпНро▒рпБ (ро╡роорпНроЪ ро╡ро┐ро░рпБродрпНродро┐).");
    else cons.push("роорпБроХрпНроХро┐ропрооро╛рой роЗро░ро╛роЪро┐рокрпН рокрпКро░рпБродрпНродроорпН роЗро▓рпНро▓рпИ - ро╡роорпНроЪ ро╡ро┐ро░рпБродрпНродро┐ропро┐ро▓рпН родро╛роородроорпН роПро▒рпНрокроЯро▓ро╛роорпН.");

    if (results.rasiAthipathi.status === "Match") pros.push("роЗро░ро╛роЪро┐ роЕродро┐рокродро┐рокрпН рокрпКро░рпБродрпНродроорпН роЙро│рпНро│родрпБ (роХрпБроЯрпБроорпНрок роТро▒рпНро▒рпБроорпИ).");
    else cons.push("роорпБроХрпНроХро┐ропрооро╛рой роЗро░ро╛роЪро┐ роЕродро┐рокродро┐рокрпН рокрпКро░рпБродрпНродроорпН роЗро▓рпНро▓рпИ - роХрпБроЯрпБроорпНрокродрпНродро┐ро▓рпН роХро░рпБродрпНродрпБ ро╡рпЗро▒рпБрокро╛роЯрпБроХро│рпН ро╡ро░ро▓ро╛роорпН.");

    if (results.yoni.status === "Match") pros.push("ропрпЛройро┐рокрпН рокрпКро░рпБродрпНродроорпН роЪро┐ро▒рокрпНрокрпБ (родро╛роорпНрокродрпНродро┐роп роЪрпБроХроорпН).");
    else cons.push("роорпБроХрпНроХро┐ропрооро╛рой ропрпЛройро┐рокрпН рокрпКро░рпБродрпНродроорпН роЗро▓рпНро▓рпИ - родро╛роорпНрокродрпНродро┐роп ро╡ро╛ро┤рпНро╡ро┐ро▓рпН родро┐ро░рпБрокрпНродро┐ропро┐ройрпНроорпИ роПро▒рпНрокроЯро▓ро╛роорпН.");

    if (results.mahendra.status === "Match") pros.push("роороХрпЗроирпНродро┐ро░рокрпН рокрпКро░рпБродрпНродроорпН роЙро│рпНро│родрпБ (рокрпБродрпНродро┐ро░ рокро╛роХрпНроХро┐ропроорпН рооро▒рпНро▒рпБроорпН роЪрпЖро▓рпНро╡роорпН).");
    else cons.push("роорпБроХрпНроХро┐ропрооро╛рой роороХрпЗроирпНродро┐ро░рокрпН рокрпКро░рпБродрпНродроорпН роЗро▓рпНро▓рпИ - рокрпБродрпНродро┐ро░ рокро╛роХрпНроХро┐ропроорпН родро╛роородрооро╛роХро▓ро╛роорпН.");

    if (hasCharts) {
        if (doshamResult.match === "Match") {
            pros.push("рокро╛рокроЪро╛роорпНропроорпН (Dosha Equivalency) роЙро│рпНро│родрпБ. родроЯрпИроХро│рпН роирпАроЩрпНроХро┐ роиройрпНроорпИроХро│рпН роироЯроХрпНроХрпБроорпН.");
        } else {
            cons.push("рокрпЖрогрпНрогро┐ройрпН роЬро╛родроХрокрпН рокро╛рокрокрпН рокро▓ройрпН роЖрогро┐ройрпН роЬро╛родроХродрпНродрпИ ро╡ро┐роЯ роЕродро┐роХроорпН. роЗродрпБ роЖропрпБро│рпИропрпБроорпН, роЖро░рпЛроХрпНроХро┐ропродрпНродрпИропрпБроорпН рокро╛родро┐роХрпНроХрпБроорпН.");
        }

        if (!bNavamsa.isGood || !gNavamsa.isGood) {
            cons.push("роиро╡ро╛роорпНроЪродрпНродро┐ро▓рпН 7-роорпН ро╡рпАроЯрпНроЯро┐ро▓рпН рокро╛рок роХро┐ро░роХроЩрпНроХро│ро┐ройрпН родро╛роХрпНроХроорпН роЙро│рпНро│родрпБ.");
        } else {
            pros.push("роиро╡ро╛роорпНроЪ рокро▓роорпН (D9 Chart) роЪро┐ро▒рокрпНрокро╛роХ роЙро│рпНро│родрпБ.");
        }
    } else {
        cons.push("роХроЯрпНроЯроЩрпНроХро│рпН (Charts) роЗро▓рпНро▓ро╛родродро╛ро▓рпН роХро┐ро░роХ рокро▓роорпН, рокро╛рокроЪро╛роорпНропроорпН, рооро▒рпНро▒рпБроорпН роиро╡ро╛роорпНроЪроорпН роЕро▒ро┐ропрокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ.");
    }

    const totalScore = Object.values(results).reduce((acc, curr) => acc + curr.score, 0);
    const finalScore = Math.min(12, totalScore);

    let basePercentage = (finalScore / 12) * 100;

    // Apply Chart-based Penalties/Bonuses
    if (hasCharts) {
        if (doshamResult.match === "Match") {
            basePercentage += 8; // Bonus for good dosham match
        } else if (doshamResult.match === "No Match") {
            basePercentage -= 20; // Heavy penalty for bad dosham
        }

        if (bNavamsa.isGood && gNavamsa.isGood) {
            basePercentage += 8; // Both have good navamsa
        } else if (!bNavamsa.isGood && !gNavamsa.isGood) {
            basePercentage -= 15; // Both have bad navamsa
        } else {
            basePercentage -= 5; // One has bad navamsa
        }
    }

    // Huge penalty for bad rajju, regardless of score
    if (results.rajju.status === "No Match") {
        basePercentage -= 30; // Rajju is critical
    }

    // Keep within bounds 0-100
    const percentage = Math.max(0, Math.min(100, Math.round(basePercentage)));

    const lifeSummary = generateLifeSummary(bride, groom, bDosham, gDosham, bNavamsa, gNavamsa, hasCharts, results);

    const summaryReport = {
        percentage,
        totalScore: finalScore,
        pros,
        cons,
        lifeSummary,
        verdict: percentage > 70 ? "роЙродрпНродроорооро╛рой рокрпКро░рпБродрпНродроорпН" : percentage > 50 ? "роородрпНродро┐ропроорооро╛рой рокрпКро░рпБродрпНродроорпН" : "рокрпКро░рпБродрпНродроорпН роХрпБро▒рпИро╡рпБ"
    };

    return { results, recommendation, canMarry, score: importantMatches, doshamResult, summaryReport };
};
